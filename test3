import logging
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import Message, BufferedInputFile, InputMediaPhoto
from PIL import Image, ImageDraw, ImageFont
import io
import asyncio

TOKEN = "7841909549:AAE-IP8TXNsmHVZmuXBjb6CEiMvxaljJNz8"

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª
bot = Bot(token=TOKEN)
dp = Dispatcher()

# ØªØ®Ø²ÙŠÙ† Ø§Ù„ØµÙˆØ± Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
user_images = {}

# Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØµÙˆØ± Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
@dp.message(lambda message: message.photo)
async def handle_photo(message: Message):
    user_id = message.from_user.id

    if user_id not in user_images:
        user_images[user_id] = []

    # ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ù‚Ø§Ù…ÙˆØ³
    photo = message.photo[-1]
    file = await bot.get_file(photo.file_id)
    downloaded_file = await bot.download_file(file.file_path)

    if downloaded_file not in user_images[user_id]:
        user_images[user_id].append(downloaded_file)

    await message.answer(f"âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… {len(user_images[user_id])} ØµÙˆØ±Ø©! Ø§Ù„Ø¢Ù†ØŒ Ø£Ø±Ø³Ù„ Ù„ÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±.")

# Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù†Øµ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
@dp.message(lambda message: message.text)
async def handle_text(message: Message):
    user_id = message.from_user.id

    if user_id not in user_images or not user_images[user_id]:
        await message.answer("âš ï¸ Ù„Ù… ØªØ±Ø³Ù„ Ø£ÙŠ ØµÙˆØ± Ø¨Ø¹Ø¯! Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹.")
        return

    text = message.text
    font_size = 100
    font_path = "arial.ttf"
    font = ImageFont.truetype(font_path, font_size)

    max_width = max(Image.open(img).size[0] for img in user_images[user_id])

    while True:
        test_font = ImageFont.truetype(font_path, font_size)
        test_img = Image.new("RGB", (max_width, 200))
        test_draw = ImageDraw.Draw(test_img)
        text_width, text_height = test_draw.textbbox((0, 0), text, font=test_font)[2:]

        if text_width < max_width * 0.7:
            font = test_font
            break
        font_size -= 2  

    modified_images = []

    for image_path in user_images[user_id]:
        image = Image.open(image_path)
        draw = ImageDraw.Draw(image)

        image_width, image_height = image.size
        text_x = (image_width - text_width) // 2
        text_y = image_height - text_height - 90

        draw.text((text_x, text_y), text, font=font, fill="white", stroke_width=5, stroke_fill="black")

        img_io = io.BytesIO()
        image.save(img_io, format="PNG")
        img_io.seek(0)

        modified_images.append(BufferedInputFile(img_io.getvalue(), filename="edited_image.png"))

    # ğŸ”¥ Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø®Ø·Ø£: ØªÙ…Ø±ÙŠØ± `media=photo` Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
    media_group = [InputMediaPhoto(media=photo) for photo in modified_images]

    await message.answer_media_group(media=media_group)

    del user_images[user_id]

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
async def main():
    logging.basicConfig(level=logging.INFO)
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
